#!/usr/bin/env bash
#
# Example on-error hook: send desktop notification on failure
#
# This hook sends a desktop notification when ralph fails to complete a ticket.
# Uses notify-send (Linux) or osascript (macOS). Falls back to terminal bell.
#
# To enable:
#   1. Copy this file (remove .example extension):
#      cp notify.sh.example notify.sh
#   2. Make it executable:
#      chmod +x notify.sh
#
# Hooks receive JSON via stdin and env vars:
#   - stdin: full JSON payload (can be read once)
#   - RALPH_HOOK_EVENT: event name ("error")
#   - RALPH_HOOK_CONTEXT: full JSON payload (can be read multiple times)
#
# on-error payload structure:
#   {
#     "event": "error",
#     "ticket": { "id": 1, "title": "...", "status": "...", ... },
#     "exit_code": 1,
#     "timestamp": "2025-01-26T12:00:00Z"
#   }

set -e

# Parse fields from the JSON payload
TICKET_ID=$(echo "$RALPH_HOOK_CONTEXT" | jq -r '.ticket.id')
TICKET_TITLE=$(echo "$RALPH_HOOK_CONTEXT" | jq -r '.ticket.title')
EXIT_CODE=$(echo "$RALPH_HOOK_CONTEXT" | jq -r '.exit_code')

TITLE="Ralph Error"
MESSAGE="Ticket #$TICKET_ID failed (exit $EXIT_CODE): $TICKET_TITLE"

# Try notify-send (Linux), then osascript (macOS), then fall back to echo
if command -v notify-send &>/dev/null; then
  notify-send --urgency=critical "$TITLE" "$MESSAGE"
elif command -v osascript &>/dev/null; then
  osascript -e "display notification \"$MESSAGE\" with title \"$TITLE\""
else
  # Terminal bell + stderr as fallback
  echo -e "\a" >&2
  echo "$TITLE: $MESSAGE" >&2
fi

#!/usr/bin/env bash
#
# Example on-complete hook: log ticket completion to a file
#
# This hook appends a timestamped entry to ralph-completed.log whenever
# a ticket is successfully completed.
#
# To enable:
#   1. Copy this file (remove .example extension):
#      cp log-completion.sh.example log-completion.sh
#   2. Make it executable:
#      chmod +x log-completion.sh
#
# Hooks receive JSON via:
#   - stdin: full JSON payload (read with: ctx=$(cat))
#   - RALPH_HOOK_CONTEXT_FILE: path to JSON file (for multiple reads)
#   - RALPH_HOOK_EVENT: event name ("complete")
#
# on-complete payload structure:
#   {
#     "event": "complete",
#     "ticket": { "id": 1, "title": "...", "status": "completed", ... },
#     "summary": "## Ticket #1: ...\n- What was done\n...",
#     "timestamp": "2025-01-26T12:00:00Z",
#     "commit": "<git-hash>"
#   }

set -e

LOG_FILE="${RALPH_COMPLETION_LOG:-ralph-completed.log}"

# Parse fields from the JSON payload (using file for multiple reads)
TICKET_ID=$(jq -r '.ticket.id' "$RALPH_HOOK_CONTEXT_FILE")
TICKET_TITLE=$(jq -r '.ticket.title' "$RALPH_HOOK_CONTEXT_FILE")
TIMESTAMP=$(jq -r '.timestamp' "$RALPH_HOOK_CONTEXT_FILE")

# Append to log
echo "[$TIMESTAMP] Completed ticket #$TICKET_ID: $TICKET_TITLE" >> "$LOG_FILE"

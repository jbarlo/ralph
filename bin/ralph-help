#!/usr/bin/env bash

cat << 'EOF'
RALPH - Autonomous coding agent loop

Ralph runs Claude Code in a loop, completing tickets one at a time until done.
Progress persists in files (.ralph/tickets.json, .ralph/progress.txt) and git history.

SETUP
  ralph-init                    Bootstrap current dir with .ralph/ state directory
  ralph-build                   Build the docker image (run once, or after updating ralph)

TICKETS
  ralph-add "title" [pri] [desc]  Add a ticket (priority default: 10, lower = higher priority)
  ralph-tickets                   Show pending tickets
  ralph-tickets done              Show completed tickets
  ralph-tickets all               Show all tickets with status

EXECUTION
  ralph [max_iter]              Run loop until all tickets done (default: 20 iterations)
  ralph-once                    Run one ticket, then stop

MIGRATION
  ralph migrate                 Move root-level state files into .ralph/ directory

HOW IT WORKS
  1. Ralph reads .ralph/tickets.json for incomplete tickets
  2. Picks best ticket considering priority and dependencies
  3. Works on it, runs tests/checks to verify
  4. Marks ticket completed, appends to .ralph/progress.txt
  5. Git commits, exits. Loop starts next iteration.

FILES (in your project)
  .ralph/                State directory (created by ralph-init)
    tickets.json         Task list. Ralph updates status when done.
    progress.txt         Append-only log of what ralph did each iteration.
    hooks.d/             Lifecycle hooks directory.
  RALPH.md               Instructions for ralph (executor). Mounted as CLAUDE.md in container.
  CLAUDE.md              Instructions for you (orchestrator/planner).

  Legacy: tickets.json, progress.txt, hooks.d/ at project root are still
  supported for backwards compatibility. Use 'ralph migrate' to move them.

REQUIREMENTS
  - Must run inside a git repository (ralph commits after each iteration)
  - Docker must be running
  - ~/.claude must have valid auth (run claude once manually to set up)

DOCKER MOUNTS
  $(pwd):/workspace             Your project (read-write)
  ~/.claude temp copy           Auth for Claude Code subscription
  ~/.gitconfig                  Git identity for commits

HOOKS
  Ralph supports lifecycle hooks that run on the host machine at key events.
  Hooks can integrate with external tools (todo apps, notifications, etc).

  Directory Structure:
    .ralph/hooks.d/
      on-start/       Scripts run before each iteration starts
      on-complete/    Scripts run after a ticket is successfully completed
      on-error/       Scripts run when iteration fails

  Enabling Hooks:
    1. Create an executable script in the appropriate .ralph/hooks.d/<event>/ directory
    2. Scripts run in lexicographic order (prefix with 01-, 02-, etc. to control order)
    3. Example hooks in .ralph/hooks.d/ have .example extension; copy and chmod +x to enable

  Hook Context:
    Each hook receives JSON payload via:
      - stdin (piped, read with: ctx=$(cat))
      - RALPH_HOOK_CONTEXT_FILE env var (path to JSON file)
      - RALPH_HOOK_EVENT env var (event name: "start", "complete", "error")

  Payload Formats:

    on-start:
      {"event": "start", "ticket": {...}, "timestamp": "<iso8601>"}

    on-complete:
      {"event": "complete", "ticket": {...}, "summary": "<progress entry>", "timestamp": "<iso8601>", "commit": "<hash>"}

    on-error:
      {"event": "error", "ticket": {...}, "exit_code": <number>, "timestamp": "<iso8601>", "commit": "<hash>"}

  Use Cases:
    - Log completions to external system
    - Send notifications on errors (Slack, desktop, email)
    - Update external task trackers
    - Trigger CI/CD pipelines on completion

  Commands:
    ralph-hooks list [event]      List all hooks or hooks for specific event
    ralph-hooks add <event> <script>  Add hook (symlink script to .ralph/hooks.d/<event>/)
    ralph-hooks rm <event> <name>     Remove hook from .ralph/hooks.d/<event>/
    ralph-hooks <event> [json]        Execute hooks for event (used internally)

TIPS
  - Keep tickets small and atomic
  - Add project-specific test/build commands to CLAUDE.md
  - Check git log for iteration checkpoints
  - Use ralph-once to test before running full loop
  - Pre-flight auth check runs automatically before each session
EOF

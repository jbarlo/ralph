#!/usr/bin/env bash
set -e

SCRIPT_PATH="${BASH_SOURCE[0]}"
while [ -L "$SCRIPT_PATH" ]; do
  SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
  SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
  [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
RALPH_DIR="$(cd "$(dirname "$SCRIPT_PATH")/.." && pwd)"

source "$RALPH_DIR/lib/ralph-state.sh"

TITLE="${1:?Usage: ralph-add \"title\" [priority] [description]}"
PRIORITY="${2:-10}"
DESCRIPTION="${3:-}"

if [[ ! -f "$RALPH_TICKETS" ]]; then
  echo "No tickets.json found. Run ralph-init first."
  exit 1
fi

# Get next ID (handles empty tickets array)
NEXT_ID=$(jq '[.tickets[].id] | if length == 0 then 1 else max + 1 end' "$RALPH_TICKETS")

# Add ticket
jq --arg title "$TITLE" \
   --arg desc "$DESCRIPTION" \
   --argjson priority "$PRIORITY" \
   --argjson id "$NEXT_ID" \
   '.tickets += [{"id": $id, "title": $title, "description": $desc, "status": "pending", "priority": $priority}]' \
   "$RALPH_TICKETS" > "$RALPH_TICKETS.tmp" && mv "$RALPH_TICKETS.tmp" "$RALPH_TICKETS"

echo "Added #$NEXT_ID: $TITLE (priority: $PRIORITY)"

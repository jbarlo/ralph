#!/usr/bin/env bash
set -e

VALID_EVENTS=("on-start" "on-complete" "on-error")

is_valid_event() {
  local event="$1"
  for e in "${VALID_EVENTS[@]}"; do
    [[ "$e" == "$event" ]] && return 0
  done
  return 1
}

usage() {
  echo "Usage: ralph-hooks <command> [args]"
  echo ""
  echo "Commands:"
  echo "  <event> [json]              Execute all hooks for event"
  echo "  list [event]                List hooks (all or for specific event)"
  echo "  add <event> <script>        Add hook (symlink script to hooks.d/<event>/)"
  echo "  rm <event> <name>           Remove hook from hooks.d/<event>/"
  echo ""
  echo "Events: on-start, on-complete, on-error"
  exit 1
}

cmd_list() {
  local event="$1"

  if [[ -n "$event" ]]; then
    if ! is_valid_event "$event"; then
      echo "Error: Invalid event '$event'. Valid events: ${VALID_EVENTS[*]}"
      exit 1
    fi
    list_hooks_for_event "$event"
  else
    for e in "${VALID_EVENTS[@]}"; do
      list_hooks_for_event "$e"
    done
  fi
}

list_hooks_for_event() {
  local event="$1"
  local hooks_dir="hooks.d/$event"

  echo "$event:"
  if [[ ! -d "$hooks_dir" ]]; then
    echo "  (directory not found)"
    return
  fi

  local found=0
  while IFS= read -r -d '' hook; do
    local name
    name=$(basename "$hook")
    local status=""
    if [[ -x "$hook" ]]; then
      status="[enabled]"
    else
      status="[disabled]"
    fi
    if [[ -L "$hook" ]]; then
      local target
      target=$(readlink "$hook")
      echo "  $name $status -> $target"
    else
      echo "  $name $status"
    fi
    found=1
  done < <(find "$hooks_dir" -maxdepth 1 -type f -print0 -o -type l -print0 2>/dev/null | sort -z)

  if [[ $found -eq 0 ]]; then
    echo "  (no hooks)"
  fi
}

cmd_add() {
  local event="$1"
  local script="$2"

  if [[ -z "$event" || -z "$script" ]]; then
    echo "Usage: ralph-hooks add <event> <script>"
    exit 1
  fi

  if ! is_valid_event "$event"; then
    echo "Error: Invalid event '$event'. Valid events: ${VALID_EVENTS[*]}"
    exit 1
  fi

  if [[ ! -f "$script" ]]; then
    echo "Error: Script '$script' not found"
    exit 1
  fi

  local hooks_dir="hooks.d/$event"
  if [[ ! -d "$hooks_dir" ]]; then
    echo "Error: hooks.d/$event directory not found. Run ralph-init first."
    exit 1
  fi

  local script_abs
  script_abs=$(cd "$(dirname "$script")" && pwd)/$(basename "$script")
  local name
  name=$(basename "$script")
  local target="$hooks_dir/$name"

  if [[ -e "$target" ]]; then
    echo "Error: Hook '$name' already exists in $event"
    exit 1
  fi

  ln -s "$script_abs" "$target"
  chmod +x "$target"
  echo "Added hook: $name -> $event"
}

cmd_rm() {
  local event="$1"
  local name="$2"

  if [[ -z "$event" || -z "$name" ]]; then
    echo "Usage: ralph-hooks rm <event> <name>"
    exit 1
  fi

  if ! is_valid_event "$event"; then
    echo "Error: Invalid event '$event'. Valid events: ${VALID_EVENTS[*]}"
    exit 1
  fi

  local hooks_dir="hooks.d/$event"
  local target="$hooks_dir/$name"

  if [[ ! -e "$target" ]]; then
    echo "Error: Hook '$name' not found in $event"
    exit 1
  fi

  rm "$target"
  echo "Removed hook: $name from $event"
}

cmd_run() {
  local event="$1"
  local payload_file="$2"
  local hooks_dir="hooks.d/$event"

  if [[ ! -d "$hooks_dir" ]]; then
    exit 0
  fi

  local failed_hooks=()

  while IFS= read -r -d '' hook; do
    if [[ -x "$hook" ]]; then
      local hook_name
      hook_name=$(basename "$hook")
      echo "Running hook: $hook_name"

      export RALPH_HOOK_EVENT="$event"
      export RALPH_HOOK_CONTEXT_FILE="$payload_file"
      if ! cat "$payload_file" | "$hook"; then
        echo "Hook failed: $hook_name"
        failed_hooks+=("$hook_name")
      fi
    fi
  done < <(find "$hooks_dir" -maxdepth 1 -type f -print0 -o -type l -print0 2>/dev/null | sort -z)

  if [[ ${#failed_hooks[@]} -gt 0 ]]; then
    echo ""
    echo "Hook errors:"
    for h in "${failed_hooks[@]}"; do
      echo "  - $h"
    done
    exit 1
  fi
}

if [[ -z "$1" || "$1" == "-h" || "$1" == "--help" ]]; then
  usage
fi

case "$1" in
  list)
    cmd_list "$2"
    ;;
  add)
    cmd_add "$2" "$3"
    ;;
  rm)
    cmd_rm "$2" "$3"
    ;;
  on-start|on-complete|on-error)
    cmd_run "$1" "$2"
    ;;
  *)
    echo "Error: Unknown command '$1'"
    usage
    ;;
esac

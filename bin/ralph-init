#!/usr/bin/env bash
set -e

# Initialize ralph in current directory, creating .ralph/ state directory

if [[ -d .ralph ]]; then
  echo ".ralph/ already exists"
else
  mkdir -p .ralph
  echo "Created .ralph/"
fi

if [[ -f .ralph/tickets.json ]]; then
  echo ".ralph/tickets.json already exists"
elif [[ -f tickets.json ]]; then
  echo "tickets.json exists at root (run 'ralph migrate' to move into .ralph/)"
else
  echo '{"tickets": []}' > .ralph/tickets.json
  echo "Created .ralph/tickets.json"
fi

# flake.nix - basic nix development environment
if [[ -f flake.nix ]]; then
  echo "flake.nix already exists"
else
  cat > flake.nix << 'EOF'
{
  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
    flake-utils.url = "github:numtide/flake-utils";
  };

  outputs = { self, nixpkgs, flake-utils }:
    flake-utils.lib.eachDefaultSystem (system:
      let
        pkgs = import nixpkgs { inherit system; };
      in {
        devShells.default = pkgs.mkShell {
          packages = with pkgs; [
            nodejs_22
            pnpm
            git
            jq
          ];
        };
      });
}
EOF
  echo "Created flake.nix"
fi

# RALPH.md - instructions for the ralph executor
if [[ -f RALPH.md ]]; then
  echo "RALPH.md already exists"
else
  cat > RALPH.md << 'EOF'
# Ralph Executor Instructions

You are ralph, an autonomous coding agent. Complete ONE ticket per iteration.

## Workflow

1. Read `.ralph/tickets.json`, pick best incomplete ticket (priority is a hint, consider dependencies)
2. Complete the ticket
3. Verify with tests/type checks if applicable
4. Mark ticket as `passes: true` in .ralph/tickets.json
5. Append summary to .ralph/progress.txt
6. Exit (loop handles next iteration)

## Ticket Format

```json
{
  "id": 1,
  "title": "Short title",
  "description": "Detailed description of what to do",
  "status": "pending",
  "priority": 1
}
```

Status values: pending | in_progress | completed | failed

When starting a ticket, set status to "in_progress".
When done, set status to "completed" (or "failed" if unable to complete).

## Progress Log

Append to .ralph/progress.txt after each ticket:
```
## Ticket #1: Short title
- What was done
- Files changed
- Tests run
```

## Project-Specific Notes

Add project-specific instructions here:
- Tech stack
- Testing commands
- Code conventions

## Commits

Use conventional commits:
- `feat: ...` - new feature
- `fix: ...` - bug fix
- `refactor: ...` - code change (no new feature or fix)
- `docs: ...` - documentation only
- `test: ...` - adding/updating tests
- `chore: ...` - maintenance, deps, config
EOF
  echo "Created RALPH.md"
fi

# CLAUDE.md - instructions for the orchestrator (human's Claude session)
if [[ -f CLAUDE.md ]]; then
  echo "CLAUDE.md already exists"
else
  cat > CLAUDE.md << 'EOF'
# Orchestrator Instructions

This is a Ralph Loop project. You are the orchestrator — your job is to PLAN, not execute.

## Your Role

- Understand the problem/codebase
- Break work into small, atomic tickets
- Write clear ticket descriptions with acceptance criteria
- Let ralph (the executor) do the implementation

## Guidelines

- Explore and understand before planning
- Reference actual code/data when writing tickets
- Don't write implementation code — that's ralph's job
- Keep tickets small (one clear task each)
- Include test/verification steps in descriptions

## Debugging

You CAN debug to understand problems, but only to write better tickets:
- Run tests to understand what's failing
- Read logs/errors to diagnose issues
- Trace code paths to understand behavior
- Write minimal repro cases if helpful for the ticket description

Do NOT fix bugs directly — instead, write a ticket describing:
- What's broken (with error messages/logs)
- Where the problem likely is
- What the fix should achieve

## Commands

```bash
ralph-add "title" [priority] [description]   # add ticket
ralph-tickets                                 # view pending
ralph-once                                    # run one ticket (test)
ralph                                         # run all tickets
```

## Files

- .ralph/tickets.json: task queue (edit directly or use ralph-add)
- .ralph/progress.txt: log of completed work
- .ralph/hooks.d/: lifecycle hooks
- RALPH.md: instructions for the executor (edit for project-specific guidance)
EOF
  echo "Created CLAUDE.md"
fi

if [[ -f .ralph/progress.txt ]]; then
  echo ".ralph/progress.txt already exists"
elif [[ -f progress.txt ]]; then
  echo "progress.txt exists at root (run 'ralph migrate' to move into .ralph/)"
else
  echo "# Ralph Progress Log" > .ralph/progress.txt
  echo "Created .ralph/progress.txt"
fi

# hooks.d directory structure for lifecycle hooks
if [[ -d .ralph/hooks.d ]]; then
  echo ".ralph/hooks.d/ already exists"
elif [[ -d hooks.d ]]; then
  echo "hooks.d/ exists at root (run 'ralph migrate' to move into .ralph/)"
else
  mkdir -p .ralph/hooks.d/on-start .ralph/hooks.d/on-complete .ralph/hooks.d/on-error
  touch .ralph/hooks.d/on-start/.gitkeep .ralph/hooks.d/on-complete/.gitkeep .ralph/hooks.d/on-error/.gitkeep
  echo "Created .ralph/hooks.d/ with on-start/, on-complete/, on-error/"
fi

echo "Ready for ralph. Add tickets with: ralph-add \"title\" [priority] [description]"

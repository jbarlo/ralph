# Ralph Progress Log

Append-only log of completed work. Each iteration adds to this file.

---

## Ticket #1: Create hooks.d directory structure
- Updated bin/ralph-init to create hooks.d/ directory with subdirectories: on-start/, on-complete/, on-error/
- Each subdirectory contains a .gitkeep file for git tracking
- Idempotent: skips creation if hooks.d/ already exists
- Files changed: bin/ralph-init
- Tests: verified directory structure created correctly, verified idempotence

## Ticket #2: Create ralph-hooks executor script
- Created bin/ralph-hooks script to execute lifecycle hooks
- Finds all executable files in hooks.d/<event>/ directory
- Executes hooks in lexicographic order (01-first, 02-second, etc.)
- Passes JSON context via stdin, RALPH_HOOK_EVENT, and RALPH_HOOK_CONTEXT env vars
- Continues on failure, collects errors, reports at end
- Exits 0 if no hooks or all succeed, exits 1 if any fail
- Files changed: bin/ralph-hooks (new)
- Tests: verified with test hooks for success, failure, and continuation behavior

## Ticket #3: Implement on-start hook in ralph/ralph-once
- Added on-start hook call to bin/ralph before docker container starts
- Added on-start hook call to bin/ralph-once before docker container starts
- Hook runs on host (not in container) so hooks can access host tools
- JSON payload: {event: "start", ticket: <current-ticket>, timestamp: <iso8601>}
- Gets highest priority pending/in_progress ticket from tickets.json
- Hook failures don't abort ralph (continues with || true)
- Files changed: bin/ralph, bin/ralph-once
- Tests: verified JSON payload generation, tested with temporary hook script

## Ticket #4: Implement on-complete hook
- Added on-complete hook call to bin/ralph and bin/ralph-once after docker exits
- Hook runs on host after docker exits successfully (exit code 0)
- Checks if ticket status changed to "completed" before triggering hook
- JSON payload: {event: "complete", ticket: <completed-ticket>, summary: <last-progress-entry>, timestamp: <iso8601>}
- Summary extracted from progress.txt using awk (last ## Ticket entry)
- Hook failures don't abort ralph (continues with || true)
- Files changed: bin/ralph, bin/ralph-once
- Tests: verified bash syntax, tested jq/awk commands, tested hook invocation with ralph-hooks

## Ticket #5: Implement on-error hook
- Added on-error hook call to bin/ralph and bin/ralph-once
- Hook triggers when: docker exits non-zero OR ticket wasn't marked completed
- Refactored hook logic to use if/elif for on-complete vs on-error (mutually exclusive)
- JSON payload: {event: "error", ticket: <ticket-json>, exit_code: <code>, timestamp: <iso8601>}
- Uses TICKET_AFTER if available, falls back to TICKET_BEFORE
- Hook failures don't abort ralph (continues with || true)
- Files changed: bin/ralph, bin/ralph-once
- Tests: verified bash syntax, tested JSON payload generation, tested ralph-hooks invocation

## Ticket #6: Add example hook scripts
- Created hooks.d/on-complete/log-completion.sh.example: logs completed tickets to ralph-completed.log
- Created hooks.d/on-error/notify.sh.example: sends desktop notification on failure (notify-send/osascript/fallback)
- Both hooks include detailed comments: how to enable, payload structure, parsing examples
- Not executable by default (.example extension), require copy + chmod +x to enable
- Files changed: hooks.d/on-complete/log-completion.sh.example, hooks.d/on-error/notify.sh.example
- Tests: verified bash syntax, tested both hooks with sample JSON payloads

## Ticket #7: Document hooks.d in ralph-help
- Added new HOOKS section to bin/ralph-help documentation
- Documents directory structure (hooks.d/on-start, on-complete, on-error)
- Explains how to enable hooks (create executable script, lexicographic ordering)
- Documents hook context (stdin, RALPH_HOOK_CONTEXT, RALPH_HOOK_EVENT env vars)
- Shows payload format for each event type with JSON examples
- Lists use cases: logging, notifications, external task trackers, CI/CD
- Mentions ralph-hooks command for manual hook execution
- Files changed: bin/ralph-help
- Tests: verified ralph-help output renders correctly

## Ticket #8: Add ralph hooks CLI management
- Extended bin/ralph-hooks with subcommands: list, add, rm
- `ralph-hooks list [event]`: lists all hooks or hooks for specific event, shows enabled/disabled status and symlink targets
- `ralph-hooks add <event> <script>`: creates symlink to script in hooks.d/<event>/, makes it executable
- `ralph-hooks rm <event> <name>`: removes hook from hooks.d/<event>/
- All commands validate event name against valid events (on-start, on-complete, on-error)
- Updated bin/ralph-help to document new commands
- Files changed: bin/ralph-hooks, bin/ralph-help
- Tests: verified all commands (list, add, rm) with valid/invalid inputs, tested error handling

## Ticket #10: Move iteration loop from container to host
- Refactored bin/ralph to loop on host instead of inside docker container
- Each iteration: runs on-start hook, starts docker for ONE ticket, runs on-complete/on-error hook
- Hooks now fire per-ticket since docker exits after each iteration
- Preserved MAX_ITER limit (default 20, configurable via first arg)
- Removed ralph-loop.sh (no longer needed)
- Updated Dockerfile to use ralph-once.sh as default CMD
- Files changed: bin/ralph, Dockerfile, ralph-loop.sh (deleted)
- Tests: verified bash syntax for bin/ralph and bin/ralph-once

## Ticket #9: Move ralph state to .ralph/ directory
- Created lib/ralph-state.sh shared helper that resolves state paths (.ralph/ preferred, root fallback)
- Updated all bin/ scripts (ralph, ralph-once, ralph-hooks, ralph-init, ralph-add, ralph-tickets) to source lib/ralph-state.sh and use $RALPH_TICKETS, $RALPH_PROGRESS, $RALPH_HOOKS_DIR
- ralph-init now creates .ralph/ directory structure instead of root-level files; detects existing root files and suggests migration
- Created bin/ralph-migrate to move root-level tickets.json, progress.txt, hooks.d/ into .ralph/ with conflict detection
- Added `ralph migrate` and `ralph hooks` subcommand dispatch in bin/ralph
- Updated bin/ralph-help to document .ralph/ structure, migration, and legacy fallback
- Updated prompt.md to instruct container agent to check .ralph/ paths first with root fallback
- Added ralph_resolve_state re-resolution call after docker exits (handles mid-run migration)
- Updated .exports to include ralph-migrate
- Files changed: lib/ralph-state.sh (new), bin/ralph, bin/ralph-once, bin/ralph-hooks, bin/ralph-init, bin/ralph-add, bin/ralph-tickets, bin/ralph-help, bin/ralph-migrate (new), prompt.md, .exports, test/test-state-dir.sh (new)
- Tests: 27 integration tests pass (state resolution, fallback, migration, conflict handling, init, add, tickets)

